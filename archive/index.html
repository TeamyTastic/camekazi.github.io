<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototype Archive</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1a1a;
      --ink-dim: #6b6b6b;
      --ink-faint: #a0a0a0;
      --cream: #faf6f1;
      --warm: #e8dfd0;
      --accent: #c2410c;
      --surface: #ffffff;
      --border: rgba(0,0,0,0.08);
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--cream);
      color: var(--ink);
      min-height: 100vh;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    h1 {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 36px;
      font-weight: 400;
      margin-bottom: 8px;
      color: var(--ink);
    }

    .subtitle {
      font-size: 14px;
      color: var(--ink-dim);
      margin-bottom: 32px;
    }

    .current-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .current-card {
      background: var(--surface);
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 40px;
      text-decoration: none;
      display: block;
      transition: box-shadow 0.2s ease;
    }

    .current-card:hover {
      box-shadow: 0 4px 16px rgba(194, 65, 12, 0.12);
    }

    .current-card .title {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 22px;
      color: var(--ink);
      margin-bottom: 4px;
    }

    .current-card .meta {
      font-size: 12px;
      color: var(--ink-faint);
    }

    .archive-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--ink-faint);
      margin-bottom: 12px;
    }

    .archive-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .archive-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      text-decoration: none;
      color: var(--ink);
      transition: background 0.15s ease;
    }

    .archive-item:last-child { border-bottom: none; }

    .archive-item:hover {
      background: rgba(194, 65, 12, 0.03);
    }

    .archive-item .title {
      font-size: 15px;
      font-weight: 500;
    }

    .archive-item .date {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--ink-faint);
      white-space: nowrap;
      margin-left: 16px;
    }

    .archive-item .title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .archive-item .badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .badge-gist {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .archive-item .arrow {
      color: var(--ink-faint);
      margin-left: 12px;
      font-size: 14px;
      transition: transform 0.15s ease;
    }

    .archive-item:hover .arrow {
      transform: translateX(3px);
      color: var(--accent);
    }

    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 12px;
      color: var(--ink-faint);
    }

    .footer a {
      color: var(--accent);
      text-decoration: none;
    }

    @media (max-width: 600px) {
      h1 { font-size: 28px; }
      .container { padding: 32px 16px 60px; }
      .archive-item { padding: 12px 16px; }
      .archive-item .title { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Prototype Archive</h1>
    <p class="subtitle">Every prototype published via <code style="font-family:'JetBrains Mono',monospace; font-size:12px; background:var(--warm); padding:2px 6px; border-radius:4px;">proto share</code>. Latest at top.</p>

    <div class="current-label">Current</div>
    <a class="current-card" href="https://teamytastic.github.io/camekazi.github.io/prototype" id="current-link">
      <div class="title" id="current-title">Loading...</div>
      <div class="meta">teamytastic.github.io/camekazi.github.io/prototype</div>
    </a>

    <div class="archive-label">Archive</div>
    <div class="archive-list" id="archive-list">
      <div style="padding:20px; text-align:center; color:var(--ink-faint);">Loading archive...</div>
    </div>

    <div class="footer">
      <a href="https://teamytastic.github.io/camekazi.github.io/">Home</a>
    </div>
  </div>

  <script>
    const GIST_VIEWER = 'https://teamytastic.github.io/camekazi.github.io/gist';
    const GIST_USER = 'Camekazi';
    const ARCHIVE_BASE = 'https://teamytastic.github.io/camekazi.github.io/archive/';

    // Normalize a title for dedup comparison
    function normalizeTitle(str) {
      return str.toLowerCase()
        .replace(/^\d{4}[\s-]\d{2}[\s-]\d{2}[\s-]?/, '') // strip leading date
        .replace(/[-_]/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/\b(full|v2|prototype|interactive|pattern tracking)\b/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Parse archive filename into { title, date, url, source }
    function parseArchiveFile(file) {
      const name = file.name.replace('.html', '');
      const dateMatch = name.match(/^(\d{4}-\d{2}-\d{2})-(.+)$/);
      let date = '', title = name;
      if (dateMatch) {
        date = dateMatch[1];
        title = dateMatch[2]
          .replace(/-/g, ' ')
          .replace(/_/g, ' ')
          .replace(/\b\w/g, c => c.toUpperCase());
      }
      return {
        title,
        date,
        sortKey: name,
        url: ARCHIVE_BASE + file.name,
        source: 'archive'
      };
    }

    // Parse gist into { title, date, url, source }
    function parseGist(gist) {
      const desc = gist.description || '';
      // Extract title from "Prototype: name" or use full description
      let title = desc.replace(/^Prototype:\s*/i, '');
      // Strip date prefixes like "2026-02-19-"
      title = title.replace(/^\d{4}-\d{2}-\d{2}-?/, '');
      // Strip verbose suffixes from gist descriptions
      title = title.replace(/\s*[-–—]\s+.{20,}$/, '');
      title = title
        .replace(/[-_]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .replace(/\b\w/g, c => c.toUpperCase());

      const date = gist.created_at.slice(0, 10);

      // Find the first HTML file in the gist
      const files = Object.values(gist.files);
      const htmlFile = files.find(f => f.filename.endsWith('.html'));
      if (!htmlFile) return null;

      const url = `${GIST_VIEWER}/?${gist.id}/${htmlFile.filename}`;

      return {
        title,
        date,
        sortKey: `${date}-${title.toLowerCase().replace(/\s+/g, '-')}`,
        url,
        source: 'gist',
        gistId: gist.id
      };
    }

    async function loadArchive() {
      const list = document.getElementById('archive-list');

      try {
        // Fetch archive files and gists in parallel
        const [archiveRes, gistsRes] = await Promise.allSettled([
          fetch('https://api.github.com/repos/TeamyTastic/camekazi.github.io/contents/archive'),
          fetch(`https://api.github.com/users/${GIST_USER}/gists?per_page=100`)
        ]);

        let items = [];

        // Process archive files
        if (archiveRes.status === 'fulfilled' && archiveRes.value.ok) {
          const files = await archiveRes.value.json();
          const htmlFiles = files.filter(f => f.name.endsWith('.html') && f.name !== 'index.html');
          items.push(...htmlFiles.map(parseArchiveFile));
        }

        // Process gists — filter to prototypes with HTML files
        if (gistsRes.status === 'fulfilled' && gistsRes.value.ok) {
          const gists = await gistsRes.value.json();
          const protoGists = gists
            .filter(g => {
              const hasHtml = Object.values(g.files).some(f => f.filename.endsWith('.html'));
              const isProto = (g.description || '').toLowerCase().includes('prototype');
              return hasHtml && isProto;
            });

          for (const g of protoGists) {
            const parsed = parseGist(g);
            if (parsed) items.push(parsed);
          }
        }

        // Deduplicate: if a gist and archive entry have similar titles,
        // keep only the archive version (it's the canonical copy)
        const archiveTitles = new Set(
          items.filter(i => i.source === 'archive').map(i => normalizeTitle(i.title))
        );

        // Deduplicate gists: keep latest per normalized title, skip if archive has it
        const seenGistTitles = new Map();
        const gistItems = items.filter(i => i.source === 'gist');
        // Sort gists newest first so the first seen is the latest
        gistItems.sort((a, b) => b.date.localeCompare(a.date));

        const keepGistIds = new Set();
        for (const gist of gistItems) {
          const norm = normalizeTitle(gist.title);
          if (archiveTitles.has(norm)) continue; // archive has it
          if (seenGistTitles.has(norm)) continue; // already kept a newer one
          seenGistTitles.set(norm, gist);
          keepGistIds.add(gist.gistId);
        }

        items = items.filter(item =>
          item.source === 'archive' || keepGistIds.has(item.gistId)
        );

        // Sort newest first
        items.sort((a, b) => b.sortKey.localeCompare(a.sortKey));

        // Try to detect current prototype name
        try {
          const protoRes = await fetch('https://api.github.com/repos/TeamyTastic/camekazi.github.io/contents/prototype');
          const protoFiles = await protoRes.json();
          if (Array.isArray(protoFiles)) {
            const indexFile = protoFiles.find(f => f.name === 'index.html');
            if (indexFile) {
              const contentRes = await fetch(indexFile.url);
              const contentData = await contentRes.json();
              const html = atob(contentData.content);
              const titleMatch = html.match(/<title>([^<]+)<\/title>/);
              if (titleMatch && titleMatch[1] !== 'Prototype') {
                document.getElementById('current-title').textContent = titleMatch[1];
              } else {
                document.getElementById('current-title').textContent = 'Latest Prototype';
              }
            }
          }
        } catch (e) {
          document.getElementById('current-title').textContent = 'Latest Prototype';
        }

        // Render
        list.innerHTML = '';

        for (const item of items) {
          const link = document.createElement('a');
          link.className = 'archive-item';
          link.href = item.url;

          const badge = item.source === 'gist'
            ? '<span class="badge badge-gist">gist</span>'
            : '';

          link.innerHTML = `
            <span class="title-row">
              <span class="title">${item.title}</span>
              ${badge}
            </span>
            <span style="display:flex; align-items:center;">
              <span class="date">${item.date}</span>
              <span class="arrow">&rarr;</span>
            </span>
          `;
          list.appendChild(link);
        }

        if (items.length === 0) {
          list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--ink-faint);">No archived prototypes yet.</div>';
        }
      } catch (e) {
        list.innerHTML =
          '<div style="padding:20px; text-align:center; color:var(--ink-faint);">Could not load archive. <a href="https://github.com/TeamyTastic/camekazi.github.io/tree/main/archive" style="color:var(--accent);">View on GitHub</a></div>';
      }
    }

    loadArchive();
  </script>
</body>
</html>
